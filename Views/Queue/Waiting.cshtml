@model QueueWaitingViewModel

@{
    ViewData["Title"] = "Waiting";
}

<div class="text-center mt-5">
    <h2 class="fw-bold">@Model.QueueName</h2>
    <p class="text-muted">Please stay nearby. This page updates automatically.</p>
</div>

<div class="row text-center mt-5">
    <div class="col-md-4">
        <div class="text-muted">Your position</div>
        <div id="position" class="display-4 fw-bold">#@Model.Position</div>
    </div>

    <div class="col-md-4">
        <div class="text-muted">People ahead</div>
        <div id="ahead" class="display-6">@Model.PeopleAhead</div>
    </div>

    <div class="col-md-4">
        <div class="text-muted">Estimated wait</div>
        <div id="estimated" class="display-6">@Model.EstimatedWaitMinutes min</div>
    </div>
</div>

<div id="message" class="alert alert-info text-center mt-5 col-lg-6 mx-auto">
    @(Model.Position == 1
        ? "It’s your turn! Please proceed to service."
        : "Please stay nearby. This page updates automatically.")
</div>

<script>
    const queueId = @Model.QueueId;
    const entryId = @Model.EntryId;

    const position = document.getElementById("position");
    const ahead = document.getElementById("ahead");
    const estimated = document.getElementById("estimated");
    const message = document.getElementById("message");

    async function queueRefreshStatus() {
        try {
            const response = await fetch(`/Queue/WaitingStatus/${queueId}/${entryId}`);
            const data = await response.json();
            
            if (data.state === "waiting") {
                position.innerText = "#" + data.position;
                ahead.innerText = data.ahead;
                estimated.innerText = data.estimated + " min";
                
                if (data.position === 1)
                    message.innerText = "It’s your turn! Please proceed to service.";
                else
                    message.innerText = "Please stay nearby. This page updates automatically.";
                    
                return;
            }
            
            if (data.state === "your_turn") {
                position.innerText = "#1";
                ahead.innerText = "0";
                estimated.innerText = "0 min";
                message.innerText = "It’s your turn! Please proceed to service.";
                return;
            }
            
            if (["served","skipped","expired","removed","queue_removed"].includes(data.state)) {
                window.location.href = `/Queue/WaitingResult?state=${data.state}`;
            }
        }
        catch {
            message.innerText = "Connection lost.";
        }
    }

    setInterval(queueRefreshStatus, 5000);
</script>